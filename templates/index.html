<!DOCTYPE html>
<html>
<head>
    <title>äº‘å—çŠ¯ç½ªæ•°æ®å¯è§†åŒ–åˆ†æç³»ç»Ÿ</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .dashboard-header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(15, 12, 41, 0.7);
            border-radius: 16px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .dashboard-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 400;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: rgba(25, 25, 35, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(0, 212, 255, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
        }

        .filter-label {
            color: #00d4ff;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label i {
            font-size: 16px;
        }

        .filter-select, .time-input {
            background: rgba(40, 40, 50, 0.9);
            border: 2px solid rgba(0, 212, 255, 0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .filter-select:focus, .time-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .filter-select option {
            background: #2a2a3a;
            color: white;
        }

        .button-group {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        /* å›¾è¡¨ç½‘æ ¼å¸ƒå±€ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: rgba(15, 12, 41, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.1);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .chart-header {
            padding: 16px 20px;
            background: rgba(0, 212, 255, 0.1);
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 4px;
        }

        .chart-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .chart-body {
            flex: 1;
            padding: 15px;
            position: relative;
            min-height: 300px;
        }

        /* å›¾è¡¨å°ºå¯¸ */
        .chart {
            width: 100%;
            height: 100%;
            min-height: 300px;
        }

        /* ç¬¬ä¸€è¡Œï¼šæ—¶é—´è¶‹åŠ¿å›¾è¡¨ */
        .trend-row {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .trend-row .chart-card {
            grid-column: span 1;
        }

        /* ç¬¬äºŒè¡Œï¼šç±»å‹åˆ†æå’Œçƒ­åŠ›å›¾ */
        .analysis-row {
            grid-column: span 12;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        /* ç¬¬ä¸‰è¡Œï¼šåœ°å›¾å’Œå…³è”åˆ†æ */
        .map-row {
            grid-column: span 12;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        /* åœ°å›¾æ ·å¼ */
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(40, 40, 50, 0.3);
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-cards {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(25, 25, 35, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 212, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0, 212, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 153, 255, 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .trend-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .trend-row .chart-card:last-child {
                grid-column: span 2;
            }
        }

        @media (max-width: 1200px) {
            .analysis-row,
            .map-row {
                grid-template-columns: 1fr;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .trend-row,
            .analysis-row,
            .map-row {
                grid-template-columns: 1fr;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }

            .button-group {
                justify-content: stretch;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 12, 41, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 212, 255, 0.7);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            position: relative;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 212, 255, 0.1);
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* è°ƒè¯•é¢æ¿ */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 107, 107, 0.9);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 12px;
            color: white;
            display: none;
        }

        .debug-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- å¤´éƒ¨ -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">äº‘å—çŠ¯ç½ªæ•°æ®å¯è§†åŒ–åˆ†æç³»ç»Ÿ</h1>
            <p class="dashboard-subtitle">åŸºäºæ—¶ç©ºåˆ†å¸ƒçš„çŠ¯ç½ªæ¨¡å¼åˆ†æä¸é¢„æµ‹ (æ•°æ®èŒƒå›´: 1992-2019å¹´)</p>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">
                    <span>ğŸ“Š</span>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="total-cases">--</div>
                    <div class="stat-label">æ¡ˆä»¶æ€»æ•°</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <span>ğŸ™ï¸</span>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="city-count">--</div>
                    <div class="stat-label">æ¶‰åŠå·å¸‚</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <span>âš–ï¸</span>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="type-count">--</div>
                    <div class="stat-label">çŠ¯ç½ªç±»å‹</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <span>ğŸ“…</span>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="time-range">--</div>
                    <div class="stat-label">æ—¶é—´è·¨åº¦</div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="filter-group">
                <label class="filter-label">
                    <span>ğŸ“</span>
                    é€‰æ‹©åœ°åŒº
                </label>
                <select id="city-select" class="filter-select">
                    <option value="all">ğŸ“Š å…¨çœæ•°æ®</option>
                    <option value="æ˜†æ˜å¸‚">ğŸ“ æ˜†æ˜å¸‚</option>
                    <option value="æ›²é–å¸‚">ğŸ“ æ›²é–å¸‚</option>
                    <option value="ç‰æºªå¸‚">ğŸ“ ç‰æºªå¸‚</option>
                    <option value="ä¿å±±å¸‚">ğŸ“ ä¿å±±å¸‚</option>
                    <option value="æ˜­é€šå¸‚">ğŸ“ æ˜­é€šå¸‚</option>
                    <option value="ä¸½æ±Ÿå¸‚">ğŸ“ ä¸½æ±Ÿå¸‚</option>
                    <option value="æ™®æ´±å¸‚">ğŸ“ æ™®æ´±å¸‚</option>
                    <option value="ä¸´æ²§å¸‚">ğŸ“ ä¸´æ²§å¸‚</option>
                    <option value="æ¥šé›„å½æ—è‡ªæ²»å·">ğŸ“ æ¥šé›„å·</option>
                    <option value="çº¢æ²³å“ˆå°¼æ—å½æ—è‡ªæ²»å·">ğŸ“ çº¢æ²³å·</option>
                    <option value="æ–‡å±±å£®æ—è‹—æ—è‡ªæ²»å·">ğŸ“ æ–‡å±±å·</option>
                    <option value="è¥¿åŒç‰ˆçº³å‚£æ—è‡ªæ²»å·">ğŸ“ è¥¿åŒç‰ˆçº³å·</option>
                    <option value="å¤§ç†ç™½æ—è‡ªæ²»å·">ğŸ“ å¤§ç†å·</option>
                    <option value="å¾·å®å‚£æ—æ™¯é¢‡æ—è‡ªæ²»å·">ğŸ“ å¾·å®å·</option>
                    <option value="æ€’æ±Ÿå‚ˆåƒ³æ—è‡ªæ²»å·">ğŸ“ æ€’æ±Ÿå·</option>
                    <option value="è¿ªåº†è—æ—è‡ªæ²»å·">ğŸ“ è¿ªåº†å·</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">
                    <span>ğŸ“…</span>
                    å¼€å§‹æ—¶é—´
                </label>
                <input type="text" id="start-time" class="time-input" placeholder="1992-01 ~ 2019-12">
            </div>

            <div class="filter-group">
                <label class="filter-label">
                    <span>ğŸ“…</span>
                    ç»“æŸæ—¶é—´
                </label>
                <input type="text" id="end-time" class="time-input" placeholder="1992-01 ~ 2019-12">
            </div>

            <div class="button-group">
                <button onclick="applyTimeFilter()" class="btn btn-primary">
                    <span>ğŸ”</span>
                    åº”ç”¨ç­›é€‰
                </button>
                <button onclick="resetTimeFilter()" class="btn btn-secondary">
                    <span>ğŸ”„</span>
                    é‡ç½®
                </button>
            </div>
        </div>

        <!-- å›¾è¡¨ç½‘æ ¼ -->
        <div class="charts-grid">
            <!-- ç¬¬ä¸€è¡Œï¼šæ—¶é—´è¶‹åŠ¿åˆ†æ -->
            <div class="trend-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">ğŸ“ˆ å¹´åº¦è¶‹åŠ¿åˆ†æ</div>
                        <div class="chart-subtitle" id="year-chart-subtitle">æ¡ˆä»¶æ•°é‡éšå¹´ä»½å˜åŒ–è¶‹åŠ¿</div>
                    </div>
                    <div class="chart-body">
                        <div id="city-year-chart" class="chart"></div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">ğŸ“… æœˆåº¦åˆ†å¸ƒ</div>
                        <div class="chart-subtitle" id="month-chart-subtitle">æ¡ˆä»¶åœ¨å„æœˆä»½çš„åˆ†å¸ƒæƒ…å†µ</div>
                    </div>
                    <div class="chart-body">
                        <div id="city-month-chart" class="chart"></div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">â° æ—¶æ®µåˆ†æ</div>
                        <div class="chart-subtitle" id="hour-chart-subtitle">æ¡ˆä»¶åœ¨ä¸€å¤©24å°æ—¶çš„åˆ†å¸ƒ</div>
                    </div>
                    <div class="chart-body">
                        <div id="city-hour-chart" class="chart"></div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šç±»å‹åˆ†æå’Œçƒ­åŠ›å›¾ -->
            <div class="analysis-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">âš–ï¸ çŠ¯ç½ªç±»å‹åˆ†å¸ƒ</div>
                        <div class="chart-subtitle" id="type-chart-subtitle">å„ç±»çŠ¯ç½ªæ¡ˆä»¶æ¯”ä¾‹åˆ†æ</div>
                    </div>
                    <div class="chart-body">
                        <div id="city-type-chart" class="chart"></div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">ğŸ”¥ æ—¶ç©ºçƒ­åŠ›å›¾</div>
                        <div class="chart-subtitle" id="heatmap-chart-subtitle">æ¡ˆä»¶åœ¨æ—¶é—´å’Œç©ºé—´ä¸Šçš„å¯†é›†ç¨‹åº¦</div>
                    </div>
                    <div class="chart-body">
                        <div id="heatmap-chart" class="chart"></div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬ä¸‰è¡Œï¼šåœ°å›¾å’Œå…³è”åˆ†æ -->
            <div class="map-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">ğŸ—ºï¸ åœ°ç†åˆ†å¸ƒå›¾</div>
                        <div class="chart-subtitle">æ¡ˆä»¶åœ¨å„å·å¸‚çš„åœ°ç†åˆ†å¸ƒ</div>
                    </div>
                    <div class="chart-body">
                        <div id="map" class="map-container"></div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">ğŸ”— å…³è”è§„åˆ™åˆ†æ</div>
                        <div class="chart-subtitle">çŠ¯ç½ªè¦ç´ ä¹‹é—´çš„å…³è”å…³ç³»</div>
                    </div>
                    <div class="chart-body">
                        <div id="apriori-chart" class="chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="dashboard-header" style="margin-top: 20px; padding: 15px;">
            <p class="dashboard-subtitle">äº‘å—çŠ¯ç½ªæ•°æ®å¯è§†åŒ–åˆ†æç³»ç»Ÿ Â© 2024 | æ•°æ®æ›´æ–°æ—¶é—´: <span id="update-time">--</span> | æ•°æ®èŒƒå›´: 1992-2019å¹´</p>
        </div>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel" id="debug-panel">
        <div>å½“å‰ç­›é€‰: <span id="debug-city">--</span></div>
        <div>æ—¶é—´èŒƒå›´: <span id="debug-time">--</span></div>
        <button onclick="testAPI()" class="debug-btn">æµ‹è¯•API</button>
    </div>

    <!-- åŠ¨æ€åŠ è½½è„šæœ¬ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/map.js') }}"></script>

    <script>
        // åŸå¸‚åç§°æ˜ å°„ï¼ˆå‰ç«¯æ˜¾ç¤ºåç§° -> åç«¯æ•°æ®åç§°ï¼‰
        const cityNameMapping = {
            'è¿ªåº†å·': 'è¿ªåº†è—æ—è‡ªæ²»å·',
            'æ¥šé›„å·': 'æ¥šé›„å½æ—è‡ªæ²»å·',
            'çº¢æ²³å·': 'çº¢æ²³å“ˆå°¼æ—å½æ—è‡ªæ²»å·',
            'æ–‡å±±å·': 'æ–‡å±±å£®æ—è‹—æ—è‡ªæ²»å·',
            'è¥¿åŒç‰ˆçº³å·': 'è¥¿åŒç‰ˆçº³å‚£æ—è‡ªæ²»å·',
            'å¤§ç†å·': 'å¤§ç†ç™½æ—è‡ªæ²»å·',
            'å¾·å®å·': 'å¾·å®å‚£æ—æ™¯é¢‡æ—è‡ªæ²»å·',
            'æ€’æ±Ÿå·': 'æ€’æ±Ÿå‚ˆåƒ³æ—è‡ªæ²»å·'
        };

        // åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');

            // é…ç½®ä¸­æ–‡
            flatpickr.localize(flatpickr.l10ns.zh);

            // åˆ›å»ºæœˆä»½é€‰æ‹©å™¨ - é™åˆ¶åœ¨1992-2019å¹´
            const startPicker = flatpickr("#start-time", {
                dateFormat: "Y-m",
                minDate: "1992-01",
                maxDate: "2019-12",
                defaultDate: null,
                placeholder: "1992-01 ~ 2019-12",
                onChange: function(selectedDates, dateStr) {
                    console.log('ğŸ“… å¼€å§‹æ—¶é—´é€‰æ‹©:', dateStr);
                    updateDebugInfo();
                    if (dateStr) {
                        validateTimeInputs();
                    }
                }
            });

            const endPicker = flatpickr("#end-time", {
                dateFormat: "Y-m",
                minDate: "1992-01",
                maxDate: "2019-12",
                defaultDate: null,
                placeholder: "1992-01 ~ 2019-12",
                onChange: function(selectedDates, dateStr) {
                    console.log('ğŸ“… ç»“æŸæ—¶é—´é€‰æ‹©:', dateStr);
                    updateDebugInfo();
                    if (dateStr) {
                        validateTimeInputs();
                    }
                }
            });

            // è®¾ç½®æ›´æ–°æ—¶é—´
            document.getElementById('update-time').textContent = new Date().toLocaleDateString('zh-CN');

            // åˆå§‹åŠ è½½ç»Ÿè®¡ä¿¡æ¯
            setTimeout(() => {
                loadStats();
                updateDebugInfo();
            }, 500);

            // æ˜¾ç¤ºè°ƒè¯•é¢æ¿ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('debug-panel').style.display = 'block';
            }
        });

        // éªŒè¯æ—¶é—´è¾“å…¥
        function validateTimeInputs() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;

            if (startTime && endTime) {
                const startDate = new Date(startTime + '-01');
                const endDate = new Date(endTime + '-01');

                if (startDate > endDate) {
                    alert('âš ï¸ å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´');
                    document.getElementById('start-time').value = '';
                    document.getElementById('end-time').value = '';
                    return false;
                }

                // éªŒè¯æ˜¯å¦åœ¨1992-2019èŒƒå›´å†…
                const minYear = 1992;
                const maxYear = 2019;
                const startYear = startDate.getFullYear();
                const endYear = endDate.getFullYear();

                if (startYear < minYear || startYear > maxYear) {
                    alert(`âŒ å¼€å§‹æ—¶é—´å¿…é¡»åœ¨${minYear}å¹´è‡³${maxYear}å¹´ä¹‹é—´`);
                    return false;
                }
                if (endYear < minYear || endYear > maxYear) {
                    alert(`âŒ ç»“æŸæ—¶é—´å¿…é¡»åœ¨${minYear}å¹´è‡³${maxYear}å¹´ä¹‹é—´`);
                    return false;
                }
            }

            return true;
        }

        // æ›´æ–°å›¾è¡¨å‰¯æ ‡é¢˜
        function updateChartSubtitles(city, startTime, endTime) {
            const cityText = city === 'all' ? 'å…¨çœ' : city;
            const timeText = startTime && endTime ? `æ—¶é—´èŒƒå›´: ${startTime} è‡³ ${endTime}` : 'å…¨éƒ¨æ—¶é—´ (1992-2019)';

            // æ›´æ–°å„ä¸ªå›¾è¡¨çš„å‰¯æ ‡é¢˜
            document.getElementById('year-chart-subtitle').textContent = `${cityText} | ${timeText}`;
            document.getElementById('month-chart-subtitle').textContent = `${cityText} | ${timeText}`;
            document.getElementById('hour-chart-subtitle').textContent = `${cityText} | ${timeText}`;
            document.getElementById('type-chart-subtitle').textContent = `${cityText} | ${timeText}`;
            document.getElementById('heatmap-chart-subtitle').textContent = `${cityText} | ${timeText}`;
        }

        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo() {
            const city = document.getElementById('city-select').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;

            const cityText = city === 'all' ? 'å…¨çœ' : city;
            const timeText = startTime && endTime ? `${startTime} è‡³ ${endTime}` : '1992-2019 (å…¨éƒ¨æ—¶é—´)';

            document.getElementById('debug-city').textContent = cityText;
            document.getElementById('debug-time').textContent = timeText;

            // æ›´æ–°å›¾è¡¨å‰¯æ ‡é¢˜
            updateChartSubtitles(city, startTime, endTime);
        }

        // æµ‹è¯•API
        function testAPI() {
            const city = document.getElementById('city-select').value;
            const startTime = document.getElementById('start-time').value || 'all';
            const endTime = document.getElementById('end-time').value || 'all';

            console.log('ğŸ”§ æµ‹è¯•APIå‚æ•°:', {city, startTime, endTime});

            // æµ‹è¯•å„ä¸ªAPIç«¯ç‚¹
            const endpoints = [
                'year_counts',
                'month_counts',
                'hour_counts',
                'type_counts',
                'year_month_counts'
            ];

            endpoints.forEach(endpoint => {
                fetch(`/api/filter/${endpoint}/${city}/${startTime}/${endTime}`)
                    .then(response => {
                        if (!response.ok) {
                            console.error(`âŒ ${endpoint} APIé”™è¯¯: ${response.status}`);
                            return null;
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data) {
                            console.log(`âœ… ${endpoint} APIå“åº”:`, {
                                æ•°æ®é‡: Array.isArray(data) ? data.length : 'N/A',
                                æ ·ä¾‹æ•°æ®: Array.isArray(data) && data.length > 0 ? data[0] : 'æ— æ•°æ®'
                            });
                        }
                    })
                    .catch(error => console.error(`âŒ ${endpoint} è¯·æ±‚å¤±è´¥:`, error));
            });
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        function loadStats() {
            console.log('ğŸ“Š åŠ è½½ç»Ÿè®¡ä¿¡æ¯');

            // åŠ è½½æ¡ˆä»¶æ€»æ•°
            fetch('/api/filter/year_counts/all')
                .then(response => response.json())
                .then(data => {
                    if (data && Array.isArray(data)) {
                        const totalCases = data.reduce((sum, item) => sum + (item.count || 0), 0);
                        document.getElementById('total-cases').textContent = totalCases.toLocaleString();

                        if (data.length > 0) {
                            const years = data.map(item => item.year).filter(year => year);
                            if (years.length > 0) {
                                const minYear = Math.min(...years);
                                const maxYear = Math.max(...years);
                                document.getElementById('time-range').textContent = `${minYear}-${maxYear}`;
                            }
                        }
                    }
                })
                .catch(error => console.error('âŒ åŠ è½½æ¡ˆä»¶æ€»æ•°å¤±è´¥:', error));

            // åŠ è½½åŸå¸‚æ•°é‡
            fetch('/api/city_counts')
                .then(response => response.json())
                .then(data => {
                    if (data && Array.isArray(data)) {
                        document.getElementById('city-count').textContent = data.length;
                    }
                })
                .catch(error => console.error('âŒ åŠ è½½åŸå¸‚ç»Ÿè®¡å¤±è´¥:', error));

            // åŠ è½½ç±»å‹æ•°é‡
            fetch('/api/type_counts')
                .then(response => response.json())
                .then(data => {
                    if (data && Array.isArray(data)) {
                        document.getElementById('type-count').textContent = data.length;
                    }
                })
                .catch(error => console.error('âŒ åŠ è½½ç±»å‹ç»Ÿè®¡å¤±è´¥:', error));
        }

        // åº”ç”¨æ—¶é—´ç­›é€‰
        function applyTimeFilter() {
            const city = document.getElementById('city-select').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;

            console.log('ğŸ”„ åº”ç”¨æ—¶é—´ç­›é€‰:', {city, startTime, endTime});

            if (!startTime || !endTime) {
                alert('âš ï¸ è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');
                return;
            }

            // éªŒè¯æ—¶é—´æ ¼å¼
            const timeRegex = /^\d{4}-\d{2}$/;
            if (!timeRegex.test(startTime)) {
                alert('âŒ å¼€å§‹æ—¶é—´æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨ YYYY-MM æ ¼å¼');
                return;
            }
            if (!timeRegex.test(endTime)) {
                alert('âŒ ç»“æŸæ—¶é—´æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨ YYYY-MM æ ¼å¼');
                return;
            }

            // éªŒè¯æ—¶é—´èŒƒå›´
            const startYear = parseInt(startTime.split('-')[0]);
            const endYear = parseInt(endTime.split('-')[0]);

            if (startYear < 1992 || startYear > 2019) {
                alert('âŒ å¼€å§‹æ—¶é—´å¿…é¡»åœ¨1992å¹´è‡³2019å¹´ä¹‹é—´');
                return;
            }
            if (endYear < 1992 || endYear > 2019) {
                alert('âŒ ç»“æŸæ—¶é—´å¿…é¡»åœ¨1992å¹´è‡³2019å¹´ä¹‹é—´');
                return;
            }

            if (!validateTimeInputs()) {
                return;
            }

            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            updateDebugInfo();

            // è°ƒç”¨charts.jsä¸­çš„åˆ·æ–°å‡½æ•°
            if (typeof refreshAllCharts === 'function') {
                refreshAllCharts();
            } else {
                console.error('âŒ charts.jsæœªæ­£ç¡®åŠ è½½');
                alert('å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // é‡ç½®æ—¶é—´ç­›é€‰
        function resetTimeFilter() {
            console.log('ğŸ”„ é‡ç½®æ—¶é—´ç­›é€‰');
            document.getElementById('start-time').value = '';
            document.getElementById('end-time').value = '';
            updateDebugInfo();

            // è°ƒç”¨charts.jsä¸­çš„åˆ·æ–°å‡½æ•°
            if (typeof refreshAllCharts === 'function') {
                refreshAllCharts();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç»Ÿè®¡
        setTimeout(() => {
            loadStats();
        }, 1000);
    </script>
</body>
</html>